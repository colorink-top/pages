<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
</head>
<body>
  filename generator 
  version: 4
  <script src="./libs/moment-with-locales.min.js"></script>
  <script src="./libs/nunjucks.min.js"></script>
  <script>
    const env = new nunjucks.Environment(null, {autoescape: false})
    // value = '', format = 'MMMM DD, YYYY', timezone = 'America/New_York'
    env.addFilter('dateFormat', (value = '', format = 'YYYY-MM-DD_HH-mm-ss', timezone = '', lang='') => {
      const result = value !== '' ? moment(value) : moment();
      if (lang) {
        result.lang(lang)
      }
      if (timezone) {
        result.tz(timezone)
      }

      return result
        .format(format)
        .toString();
    });
    const timeoutFn = function(){
      return new Promise((resolve)=>{
        setTimeout(()=>{
          resolve()
        }, 100) // 100ms
      })
    }


    window.joppLoadedFn = async (opts={})=>{
      const returnResult = {}
      try {
        if (opts.template){
          returnResult.data = env.renderString(opts.template, opts.meta)
        }
      } catch(error) {
        console.log('error::', error)
        returnResult.error = error + ''
      }
      // 这里需要一个异步操作，不然有概率出现问题
      await timeoutFn();
      console.log('success load')
      return returnResult
    }
  </script>
</body>
</html>
